variables: &global-variables
  DEFAULT_COMMIT_TITLE: 'chore(release): automatic version update'
  DOCKER_DRIVER: overlay
  DOCKER_TLS_CERTDIR: ''

.except-post-publish:
  except: &except-post-publish
    variables:
      - $CI_COMMIT_TITLE =~ /^chore\(release\):\sautomatic\sversion\supdate$/

.git-config: &git-config
  - git config user.email "bot@zenklub.com"
  - git config user.name "Zenklub Deploy Bot"
  - git remote set-url origin "https://gitlab-ci-token:$GL_TOKEN@gitlab.com/ana.jacobsen1/ds-freud.git"

.version-bump-minor: &version-bump-minor
  - git reset --hard
  - git checkout $CI_COMMIT_REF_NAME
  - git pull origin $CI_COMMIT_REF_NAME
  - cd libs/core-support && npm version minor
  - git add .
  - git commit -m "$DEFAULT_COMMIT_TITLE"
  - git push origin $CI_COMMIT_REF_NAME

.version-bump-patch: &version-bump-patch
  - git reset --hard
  - git checkout $CI_COMMIT_REF_NAME
  - git pull origin $CI_COMMIT_REF_NAME
  - cd libs/core-support && npm version patch
  - git add .
  - git commit -m "$DEFAULT_COMMIT_TITLE"
  - git push origin $CI_COMMIT_REF_NAME

.create-tag: &create-tag
  - tag=$(git tag --points-at HEAD)
  - git push origin "$tag"

.release-package: &release-package
  - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > .npmrc
  - echo "unsafe-perm = true" >> ~/.npmrc
  - npm publish --access public

#########################
# Release Minor Version #
#########################
release core (minor version):
  stage: release
  only:
    - master
  retry:
    max: 2
    when: runner_system_failure
  variables:
    <<: *global-variables
  script:
    - *git-config
    - *version-bump-minor
    - *release-package
  except: *except-post-publish
  when: manual

# #########################
# # Release Patch Version #
# #########################
release core (patch version):
  stage: release
  only:
    - master
  retry:
    max: 2
    when: runner_system_failure
  variables:
    <<: *global-variables
  script:
    - *git-config
    - *version-bump-patch
    - *release-package
  except: *except-post-publish
  when: manual
